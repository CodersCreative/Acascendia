@page "/class/{classId}"
@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared
@using studbud.Shared.Models
@inject NavigationManager navigationManager
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<PageTitle>Class</PageTitle>

<MudLayout>
	<MudAppBar Elevation="1">
		<MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit" Edge="Edge.Start"  OnClick="OnBack"/>
		<MudText Typo="Typo.h6">@(clss?.name ?? "Loading...")</MudText>
		<MudSpacer />
	</MudAppBar>
    <MudMainContent Class="pt-16 px-16">
        <MudTabs Rounded="true" Centered="true" Style="padding : 50px;">
            <MudTabPanel Text="Home">
                <MudPaper Class="pa-4 mb-4">
                    <MudText Typo="Typo.h5">Class Info</MudText>
                    <MudDivider Class="my-2" />
                    <div><b>Code:</b> @(clss?.code ?? "â€”")</div>
                </MudPaper>

                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6">People</MudText>
                    <MudDivider Class="my-2" />
                    @if (users is null || users.Count == 0)
                    {
                        <div>No members</div>
                    }
                    else
                    {
                        <MudExpansionPanel Text="@(users.Count.ToString() + " members")" >
                            @foreach (var u in users) {
                                <div>@u.username</div>
                            }
                        </MudExpansionPanel>
                    }
                </MudPaper>
            </MudTabPanel>
            <MudTabPanel Text="Stream">
                @if (messages is not null)
                {
                    foreach (var m in messages.OrderBy(m => m.date))
                    {
                        <MudPaper Class="pa-2 ma-2">@GetUserText(m.userId): @m.text</MudPaper>
                    }
                }
                <MudTextField Style="margin-top : 20px;" @ref="inputField" T="string" AutoGrow Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Send" OnAdornmentClick="OnSubmit" AdornmentAriaLabel="Submit" />
            </MudTabPanel>
            <MudTabPanel Text="Assignments">
                @if (viewing is not null) {
                    <MudPaper Class="pa-3 mb-2">
                        <AssignmentView classId="@classId" assignmentId="@viewing.id"/>
                        <MudButton OnClick="CloseAssignmentPopUp" Class="ml-auto mr-n3 mb-1" Color="Color.Error">Back</MudButton>
                    </MudPaper>
                }else if (creating is not null){
                    <MudPaper Class="pa-3 mb-2">
                        <MudTextField Style="margin : 10px;" Label="Name" @bind-Value="creating.name" />
                        <MudDatePicker Style="margin : 10px;" Label="Due (optional)" @bind-Date="creating.due"/>
                        <MudTextField Style="margin : 10px;" Label="Description" Lines="8" @bind-Value="creating.text" />
                        <div style="display : flex; flex-wrap : nowrap; margin : 10px; margin-bottom : 20px;">
                            <MudButton OnClick="CloseAssignmentPopUp" Class="ml-auto mr-n3 mb-1" Color="Color.Error">Back</MudButton>
                            <MudSpacer/>
                            <MudButton OnClick="CreateAssignment" Variant="Variant.Filled" Color="Color.Primary">Create</MudButton>
                        </div>
                    </MudPaper>
                }else {
                    @if (assignments is null || assignments.Count == 0)
                    {
                        <MudPaper Class="pa-3 mb-2">
                            <div>No assignments</div>
                            <MudButton OnClick="CreateAssignmentPopUp" Class="ml-auto mr-n3 mb-1" Color="Color.Primary">Create</MudButton>
                        </MudPaper>
                    }
                    else
                    {
                        @foreach (var a in assignments)
                        {
                            <MudPaper Class="pa-3 mb-2">
                                <div class="d-flex justify-space-between align-center">
                                    <div>
                                        <b>@a.name</b>
                                        <div class="text-muted">Due: @(a.due?.ToString("g") ?? "No due date")</div>
                                    </div>
                                    <div>
                                        <MudButton Variant="Variant.Outlined" OnClick="() => ViewAssignmentPopUp(a)">View</MudButton>
                                    </div>
                                </div>
                                <MudButton OnClick="CreateAssignmentPopUp" Class="ml-auto mr-n3 mb-1" Color="Color.Primary">Create</MudButton>
                            </MudPaper>
                        }
                    }
                }
            </MudTabPanel>
        </MudTabs>
    </MudMainContent>
</MudLayout>

@code {
	[Parameter]
	public string? classId { get; set; }
    private bool open = false;
	private Class? clss;
	private List<Message> messages = new();
	private MudTextField<string>? inputField;
	private HubConnection? hub;
	private User? current_user;
	private List<User> users = new();
	private List<Assignment> assignments = new();
	private string? showSubmitFor;
	private string submissionText = string.Empty;
    private Assignment? viewing = null;
    private Assignment? creating = null;

    enum Page {
        Home,
        Stream,
        Assignment,
    }

	private string GetUserText(string? userId)
	{
		if (current_user is null) return "Loading...";
		if (userId is null) return "Unknown";
		if (userId == current_user.id) return "You";
		var u = users?.FirstOrDefault(x => x.id == userId);
		return u?.username ?? "Unknown";
	}


    private void ToggleDrawer()
    {
        open = !open;
    } 

	private async Task OnSubmit()
	{
		if (inputField is null) return;
		if (string.IsNullOrWhiteSpace(inputField.Value)) return;
		if (current_user is null || classId is null || hub is null) return;

		var msg = new Message { text = inputField.Value.Trim(), parentId = classId, date = DateTime.Now, userId = current_user.id };
		msg = await hub.InvokeAsync<Message>(nameof(IAppHubServer.SendMessage), msg);
		messages.Add(msg);
		await inputField.Clear();
	}

	private void OnBack() => navigationManager.NavigateTo("/dash");

    private void GotoAssignment(string assignment) {
        navigationManager.NavigateTo($"/class/{classId}/assignments/{assignment}");
    }

    private void CloseAssignmentPopUp() {
        viewing = null;
        creating = null;
        StateHasChanged();
    }

    private void CreateAssignmentPopUp() {
        viewing = null;
        creating = new Assignment{
            name = "",classId = classId, due = DateTime.Today, text = ""
        };
        StateHasChanged();
    }

    private async Task CreateAssignment()
    {
        if (creating is null) return;
        var res = await hub.InvokeAsync<Assignment>(nameof(IAppHubServer.CreateAssignment), creating);
        if (res is not null) {
            assignments.Add(res);
        }
        creating = null;
    }

    private void ViewAssignmentPopUp(Assignment a) {
        viewing = a;
        creating = null;
        StateHasChanged();
    }

	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();
		hub = hubService.GetHubConnection().Build();

		hub.On<Message>(nameof(IAppHubClient.ReceiveMessage), (msg) => {
			if (msg.parentId == classId) {
				messages.Add(msg);
				StateHasChanged();
			}
		});

		await hub.StartAsync();
		messages = await hub.InvokeAsync<List<Message>>(nameof(IAppHubServer.GetMessages), classId);
		await hub.SendAsync(nameof(IAppHubServer.ConnectToChat), classId);
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		await base.OnAfterRenderAsync(firstRender);
		current_user = await sessionStorage.GetItemAsync<User>("user");
		if (clss is null)
		{
			if (hub is null || classId is null) return;

			clss = await hub.InvokeAsync<Class>(nameof(IAppHubServer.GetClass), classId);
			if (clss?.userIds is not null)
			{
				users = await hub.InvokeAsync<List<User>>(nameof(IAppHubServer.GetUsers), clss.userIds);
			}
			assignments = await hub.InvokeAsync<List<Assignment>>(nameof(IAppHubServer.GetAssignments), classId);
			StateHasChanged();
		}
	}

	private void ToggleSubmit(string? assignmentId)
	{
		if (showSubmitFor == assignmentId) showSubmitFor = null;
		else showSubmitFor = assignmentId;
	}

	private async Task SubmitAssignment(string? assignmentId)
	{
		if (assignmentId is null) return;
		if (current_user is null || hub is null) return;
		var sub = new Submission { assignmentId = assignmentId, userId = current_user.id, date = DateTime.Now, text = submissionText };
		var res = await hub.InvokeAsync<Submission>(nameof(IAppHubServer.SubmitAssignment), sub);
		submissionText = string.Empty;
		showSubmitFor = null;
	}

	public async ValueTask DisposeAsync()
	{
		if (hub is not null) await hub.DisposeAsync();
	}
}

