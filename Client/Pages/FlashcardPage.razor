@page "/flashcard/{id}"
@page "/flashcard"
@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared.Models
@using studbud.Client.Widgets
@inject NavigationManager navigationManager
@inject IDialogService Dialog
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable
@layout DashLayout

<!-- Main Chat Grid (Set a fixed height for the remaining area) -->
<MudGrid Style="height:100%;">
    <!-- Adjust 180px based on exact height of header and desired spacing -->
    <MudItem xs="12" md="2" Style="height:100%;">
        <!-- Page Header (Moved out of the grid for cleaner layout) -->
        <MudText Typo="Typo.h5" Class="mt-4 mb-2" Style="font-weight:bold;">You</MudText>
        <MudStack Row="true" Class="mb-4">
            <MudText Typo="Typo.subtitle1" Class="align-self-center">@current_user?.username</MudText>
        </MudStack>
        <!-- This inner container must use 100% height and flex column layout -->
        <div class="d-flex flex-column" style="height: 100%;">

            <!-- Top Section: Contacts List (flex-grow-1 pushes bottom card down) -->
            <div class="flex-grow-1 overflow-y-auto pr-2">
                <MudText Typo="Typo.h6" Class="mb-2" Style="font-weight:bold;">My Flashcards</MudText>

                @foreach (var f in flashcards)
                {

                    <MudCard Class="@(f.id == flashcard?.id ? "mb-2 elevation-4" : "mb-2 elevation-0 transparent-card")" Style="border-radius:12px">
                        <MudButton Variant="Variant.Text"
                                    Color="@(f.id == flashcard?.id ? Color.Primary : Color.Default)"
                                    OnClick="@(()=> {editing = true; LoadFlashcard(f.id);})"
                                    Style="width:100%; text-align:left; margin-bottom:8px; align-items:center; justify-content:flex-start; justify-items:center; align-content:center;">
                            @f.name
                        </MudButton>
                    </MudCard>
                }
            </div>
            <!-- End of Contacts List -->
            <!-- Bottom Section: This will now be pinned to the bottom -->
            <MudCard Class="mt-3 pa-2 elevation-4" Style="border-radius:15px">
                <MudText Typo="Typo.body2" Class="mb-3">Chat with friends and Classmates</MudText>

                <MudSpacer/>

                <br />
                <MudStack Row="true">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="border-radius:15px" Size="Size.Small" OnClick="OnCreateFlashcard" FullWidth="true">New Flashcard</MudButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Color="Color.Warning" Size="Size.Small" OnClick="OnFindFlashcard"/>
                </MudStack>
            </MudCard>
            <!-- End of Bottom Section -->

        </div>
    </MudItem>

    <MudItem xs="12" md="10">
        @if (flashcard is not null) {
            if (editing) {
                <CreateFlashcard flashcard="@flashcard" OnFlashcardChanged="(x) => UpdateCurrentFlashcard(x)"/>
            }else {
                <AnswerFlashcard flashcard="@flashcard"/>
            }
            <!-- <ClassView clss="@clss"/> -->
        }else{
            <MudText Typo="Typo.h6" Class="mb-2">
                Select a flashcard
            </MudText>      
        }
    </MudItem>
</MudGrid>



@code {
    [Parameter]
    public string? id {get; set;}
    public bool editing {get; set;} = false;
    public Flashcard? flashcard {get; set;}
    private HubConnection? hub;
    private List<Flashcard> flashcards = new();
    private User? current_user;


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();

        if (id is not null && flashcard is null) {
            flashcard = await hub!.InvokeAsync<Flashcard>(nameof(IAppHubServer.GetFlashcard), id);
        }
    }

    private void UpdateCurrentFlashcard(Flashcard f) {
        for (int i = 0; i < flashcards.Count; i++) {
            if (flashcards[i]?.id == flashcard?.id) {
                flashcards[i] = f;
                flashcard = f;
                StateHasChanged();
                return;
            }
        }
    }

    private async Task LoadFlashcard(string flashId, bool bypass = false) {
        if (flashId == flashcard?.id && !bypass) {
            flashcard = null;
            return;
        }
        flashcard = null;
        StateHasChanged();
        flashcard = await hub!.InvokeAsync<Flashcard>(nameof(IAppHubServer.GetFlashcard), flashId);
        StateHasChanged();
    }

    private async Task OnCreateFlashcard()
    {
        flashcard = await hub!.InvokeAsync<Flashcard>(nameof(IAppHubServer.CreateFlashcard), new Flashcard {name = "New Flashcard", code = new Random().Next(999999).ToString(),description = "",userId = current_user.id, published =false});
        flashcards.Add(flashcard);
        editing = true;
    }

    private Task OnFindFlashcard()
    {
        return Dialog.ShowAsync<SearchFlashcardDialog>("", new DialogParameters() {
            ["OnFlashcardOpened"] = (Flashcard? f) => {
                if (f is not null) {
                    flashcard = f;
                    editing = false;
                }
                StateHasChanged();
            }
        },new DialogOptions()
        {

            CloseOnEscapeKey = true 
        });

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            
            var dirFlash = await sessionStorage.GetItemAsync<string>("flashcardDirect");
            if (dirFlash is not null) {
                flashcard = await hub!.InvokeAsync<Flashcard>(nameof(IAppHubServer.GetFlashcard), dirFlash);
                editing = true;
            }

            try{
            flashcards = await hub.InvokeAsync<List<Flashcard>>(nameof(IAppHubServer.GetFlashcardsFromUser), current_user.id);
            }catch(Exception e) {}

            if (flashcard is not null) {
                await LoadFlashcard(flashcard.id, true);
            } else if (editing) {
                await OnCreateFlashcard();
            }
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}