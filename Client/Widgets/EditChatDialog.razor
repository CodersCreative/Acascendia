@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared.Models
@inject IDialogService Dialog

@inject ISnackbar Snackbar
@inject NavigationManager navigationManager
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable

<MudDialog Style="background-color: transparent; box-shadow: none;">
   <DialogContent>
        <MudCard Style="width:400px; padding:24px; border-radius:16px;" Elevation="4">
            <MudText Typo="Typo.h5" Class="mb-4">Edit Chat</MudText>
            <MudTextField T="string" Label="Name" bind-Value="@chat.name" />
            <MudStack>
                @foreach (var u in users) {   
                    <MudPaper style="display : flex; flex-wrap : nowrap; padding: 10px; margin: 10px 0 0 0; vertical-align: middle;">
                        <MudText Typo="Typo.h6" style="text-align: center; vertical-align: middle;">@u.username</MudText>
                        <MudSpacer></MudSpacer>
                        <MudIconButton Icon="@Icons.Material.Filled.Remove" OnClick="() => {OnRemoveUser(u);}" Color="Color.Inherit" Edge="Edge.Start" style="vertical-align: middle;"/>
                    </MudPaper>
                }
            </MudStack>
            <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" Class="mt-11">
                <MudTextField T="string" Label="Add User" HelperText="Add User" @ref="userField" />
                <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Inherit" Edge="Edge.Start" OnClick="OnAddUser"/>
            </MudStack>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="margin: 20px 0;" OnClick="OnSubmit">Save</MudButton>
        </MudCard>
   </DialogContent>
</MudDialog>

@code {
    [Parameter]
    public Action<Chat?> OnChatChanged {get; set;}
    [Parameter]
    public Chat chat {get; set;}
    private HubConnection? hub;
    private User current_user;
    private List<User> users = [];
    private MudTextField<string> userField;

    private async Task OnAddUser()
    {
        if (userField.Value.Trim() == current_user.username || userField.Value.Trim().Length <= 0 || users.Find((x) => {return x.username == userField.Value;}) is not null) {
            await userField.Clear();
            return;
        }

        var usr = await hub.InvokeAsync<User>(nameof(IAppHubServer.GetUserFromUsername), userField.Value.Trim());
        users.Add(usr);
        StateHasChanged();
    }

    private async Task OnSubmit()
    {
        if (users.Count < 1 ) {
            return;
        }

        var us = users.Select((x) => x.id!).ToList();
        us.Add(current_user.id);

        chat.userIds = us;

        chat = await hub.InvokeAsync<Chat>(nameof(IAppHubServer.UpdateChat), chat);

        if (userField is not null) {
            await userField.Clear();
        }

        OnChatChanged(chat);
    }

    private void OnRemoveUser(User user)
    {
        users.Remove(user);
    }


    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            users = (await hub!.InvokeAsync<List<User>>(nameof(IAppHubServer.GetUsers), chat.userIds)).Where((x) => x.id != current_user.id).ToList();
            StateHasChanged();
        }
    }


    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}