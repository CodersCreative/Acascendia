@using studbud.Shared.Models
@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using System.Linq
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject NavigationManager navigationManager
@implements IAsyncDisposable
@layout MinLayout

<MudPaper Class="d-flex flex-column" Style="border-radius:16px; padding:16px;">
    <MudStack Row="true">
        <MudTextField Label="Flashcard Name" @bind-Value="flashcard?.name" />
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Inherit" Edge="Edge.End" />
        <MudIconButton OnClick="SaveFlashcard" Icon="@Icons.Material.Filled.Save" Color="Color.Inherit" Edge="Edge.End" />
    </MudStack>
    <MudDivider/>
    <MudTextField AutoGrow Lines="6" Label="Flashcard Description" @bind-Value="flashcard.description" />
    <MudStack Row="true">
        <MudIconButton Icon="@Icons.Material.Outlined.Delete" OnClick="RemoveQuestion" Variant="Variant.Outlined" Color="Color.Warning" Class="ml-auto"/>
        <MudSpacer/>
        <MudPagination Variant="Variant.Outlined" Count="@(cards.Count)" SelectedChanged="async (x) => {editing = x; await InvokeAsync(StateHasChanged); await Task.Yield();}" Selected="@editing"/>
        <MudSpacer/>
        <MudIconButton Icon="@Icons.Material.Outlined.Add" OnClick="AddDraftCard" Variant="Variant.Outlined" Color="Color.Primary" Class="ml-auto"/>
    </MudStack>
    @if (cards.Count >= editing && editing >= 1) {
        <MudStack Row="true" AlignItems="AlignItems.Center">
            <MudSpacer/>
            <MudStack>
                <MudText Typo="Typo.h6">Front</MudText>
                <MarkdownEditor Value="@cards[getEditing()].front"/>
            </MudStack>
            <MudStack>
                <MudText Typo="Typo.h6">Back</MudText>
                <MarkdownEditor Value="@cards[getEditing()].back"/>
            </MudStack>
            <MudSpacer/>
        </MudStack>
    } else {
        <div>Out of bounds</div>
    }
</MudPaper>

@code {
    [Parameter]
    public required Flashcard flashcard {get; set;}
    [Parameter]
    public Action<Flashcard?> OnFlashcardChanged {get; set;} = (x) => {};
    private HubConnection? hub;
    private List<FlashcardCard> cards = new();
    private User? current_user;
    private int editing {get; set;} = 1;
    private int getEditing() {
        return editing - 1;
    }


    protected override async Task OnInitializedAsync()
    {
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            flashcard = await hub.InvokeAsync<Flashcard>(nameof(IAppHubServer.GetFlashcard), flashcard.id);
            cards = await hub.InvokeAsync<List<FlashcardCard>>(nameof(IAppHubServer.GetFlashcardCards), flashcard.id);

            if (cards.Count <= 0) {
                var c = new FlashcardCard { front = "", back = "",flashcardId = flashcard.id};
                cards.Add(c);
            }
                
            StateHasChanged();
            
            
        }
    } 


    private void AddDraftCard()
    {
        var c = new FlashcardCard { front = "", back = "",flashcardId = flashcard.id};
        cards.Add(c);
        editing += 1;
        StateHasChanged();
    }

    private async Task RemoveQuestion()
    {
        if (cards[getEditing()].id is not null) {
            await hub.InvokeAsync(nameof(IAppHubServer.RemoveFlashcardCard), cards[getEditing()].id);
        }
        cards.RemoveAt(getEditing());
        if (cards.Count <= 0) {
            var c = new FlashcardCard { front = "", back = "",flashcardId = flashcard.id};
            cards.Add(c);
            editing = 1;
        }
        else if (cards.Count <= editing) {
            editing -= 1;
        }
        StateHasChanged();        
    }

    private async Task SaveFlashcard()
    {
        if (hub is null) return;
        var res = await hub.InvokeAsync<Quiz>(nameof(IAppHubServer.UpdateFlashcard), flashcard);
        if (res is null) return;
        
        for (var i = 0; i < cards.Count; i++)
        {
            cards[i].flashcardId = res.id;
            var c = (cards[i].id is null) ? await hub.InvokeAsync<FlashcardCard>(nameof(IAppHubServer.CreateFlashcardCard), cards[i]) : await hub.InvokeAsync<FlashcardCard>(nameof(IAppHubServer.UpdateFlashcardCard), cards[i]);
            cards[i] = c;
        }
        OnFlashcardChanged(flashcard);
    }
    public async ValueTask DisposeAsync()
    {
        if (hub is not null) await hub.DisposeAsync();
    }
}