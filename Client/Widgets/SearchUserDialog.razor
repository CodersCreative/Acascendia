@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared.Models
@inject IDialogService Dialog

@inject ISnackbar Snackbar
@inject NavigationManager navigationManager
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable

<MudDialog Style="background-color: transparent; box-shadow: none;">
   <DialogContent>
        <MudCard Style="width:400px; padding:24px; border-radius:16px;" Elevation="4">
            <MudText Typo="Typo.h5" Class="mb-4">Search Users</MudText>
            <MudStack Style="overflow:scroll;" Spacing="3">
                <MudTextField @ref="searchField" T="string" Lines="1" Variant="Variant.Filled" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" OnAdornmentClick="() => Search(false)" AdornmentAriaLabel="Submit" />
                @foreach (var u in users) {   
                    <MudButton Variant="Variant.Outlined" Color="Color.Surface" FullWidth="true" OnClick="() => OnUserSelected(u)">
                        <MudStack>
                            <MudText Typo="Typo.h6" style="text-align: center; vertical-align: middle;">@u.username</MudText>
                        </MudStack>
                    </MudButton>
                }
            </MudStack>
        </MudCard>
   </DialogContent>
</MudDialog>

@code {
    [Parameter]
    public Action<User?> OnUserSelected {get; set;}
    private HubConnection? hub;
    MudTextField<string> searchField;
    private User current_user;
    private List<User> users = [];
    private List<User> preview = [];

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            await Search(true);
            preview = users;
        }
    }

    private async Task Search(bool bypass = false)
    {

        if (string.IsNullOrEmpty(searchField.Value) && !bypass)
        {
            users = preview;
            return;
        }

        try {
            users = (await hub.InvokeAsync<List<User>>(nameof(IAppHubServer.SearchUsers), searchField.Value)).ToList();
        } catch (Exception e) {
            users = preview;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}