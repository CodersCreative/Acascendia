@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared.Models
@inject IDialogService Dialog

@inject ISnackbar Snackbar
@inject NavigationManager navigationManager
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable

<MudDialog Style="background-color: transparent; box-shadow: none;">

   <DialogContent>
        <MudCard Style="width:400px; padding:24px; border-radius:16px;" Elevation="4">
            <MudText Typo="Typo.h5" Class="mb-4">Create Class</MudText>
            <MudTextField T="string" Label="Name" @ref="nameField" />
            <MudStack Style="overflow:scroll;">
                @foreach (var u in users) {   
                    <MudPaper style="display : flex; flex-wrap : nowrap; padding: 10px; margin: 10px 0 0 0; vertical-align: middle;">
                        <MudText Typo="Typo.h6" style="text-align: center; vertical-align: middle;">@u.username</MudText>
                        <MudSpacer></MudSpacer>
                        <MudIconButton Icon="@Icons.Material.Filled.Remove" OnClick="() => {OnRemoveUser(u);}" Color="Color.Inherit" Edge="Edge.Start" style="vertical-align: middle;"/>
                    </MudPaper>
                }
            </MudStack>
            <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" Class="mt-11">
                <MudTextField T="string" Label="Add User" HelperText="Add User" @ref="userField" />
                <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Inherit" Edge="Edge.Start" OnClick="OnAddUser"/>
            </MudStack>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="margin: 20px 0;" OnClick="OnCreateClass">Create</MudButton>
        </MudCard>
   </DialogContent>

</MudDialog>

@code {
    [Parameter]
    public Action<Class?> OnClassAdded {get; set;}
    private HubConnection? hub;
    private User current_user;
    List<User> users = [];
    MudTextField<string> nameField;
    MudTextField<string> userField;

    private async Task OnAddUser()
    {
        if (userField.Value.Trim() == current_user.username || userField.Value.Trim().Length <= 0 || users.Find((x) => {return x.username == userField.Value;}) is not null) {
            await userField.Clear();
            return;
        }

        var usr = await hub.InvokeAsync<User>(nameof(IAppHubServer.GetUserFromUsername), userField.Value.Trim());
        users.Add(usr);
        StateHasChanged();
    }

    private async Task OnCreateClass()
    {
        if (nameField is null || nameField.Value.Trim().Count() <= 0 ) {
            return;
        }

        var us = users.Select((x) => x.id!).ToList()!;
        us.Add(current_user.id);

        var clss = await hub.InvokeAsync<Class>(nameof(IAppHubServer.CreateClass), new Class {
            name = nameField?.Value,
            code = new Random().Next(999999).ToString(),
            teacherIds = [current_user.id],
            userIds = us,
        });

        if (nameField is not null) {
            await userField.Clear();
            await nameField.Clear();
        }

        OnClassAdded(clss);
    }

    private void OnRemoveUser(User user)
    {
        users.Remove(user);
    }


    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
        }
    }


    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}