@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared.Models
@inject IDialogService Dialog

@inject ISnackbar Snackbar
@inject NavigationManager navigationManager
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable

<MudDialog Style="background-color: transparent; box-shadow: none;">
   <DialogContent>
        <MudCard Style="width:400px; padding:24px; border-radius:16px;" Elevation="4">
            <MudText Typo="Typo.h5" Class="mb-4">Your Wallet</MudText>
            @if (current_user is null) {
                <MudText Typo="Typo.h6" Class="mb-4">Not Signed-In</MudText>
                <MudButton Variant="Variant.Outlined" OnClick="OnLogin" Color="Color.Warning" FullWidth="true" >Login</MudButton>
            }else{
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIconButton Icon="@Icons.Material.Filled.Money" OnClick="() => {allowDev = !allowDev; StateHasChanged();}" Variant="Variant.Text" Color="Color.Primary" Edge="Edge.Start"/>
                    <MudText Color="Color.Primary" Typo="Typo.h6">@(current_user.money ?? 0)</MudText>
                </MudStack>
                @if (allowDev) {
                    <MudTextField T="float" Label="Money" HelperText="Add Money" @ref="moneyField" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Add" OnAdornmentClick="OnAddMoney" AdornmentAriaLabel="Add Money" />
                }
                <MudDivider/>
                <MudStack Row="true">
                    <MudButton FullWidth="true" Variant="Variant.Outlined" Color="Color.Primary" Class="ml-auto" style="margin: 20px 0;" OnClick="OnTransfer">Transfer</MudButton>
                    <MudButton FullWidth="true" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="margin: 20px 0;" OnClick="() => {isBuying = true; StateHasChanged();}">Buy</MudButton>
                </MudStack>
                <MudDivider/>
                
                @if (transferUser is not null) {
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6" Class="mb-4">Transfering To:</MudText>
                        <MudText Typo="Typo.body2" Class="mb-4">@transferUser.username</MudText>
                        <MudTextField T="string" Label="Reason" AutoGrow="true" HelperText="Reason for transfer" @ref="reasonField" />
                        <MudDivider/>
                        <MudTextField T="float" Label="Amount" HelperText="Send Money" @ref="moneyField" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Send" OnAdornmentClick="OnTransferMoney" AdornmentAriaLabel="Send Money" />
                    </MudStack>
                }else if (isBuying) {
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6" Class="mb-4">Add Money</MudText>
                        <MudTextField T="string" Label="Reason" AutoGrow="true" HelperText="Reason for transfer" @ref="reasonField" />
                        <MudTextField T="string" Label="Number" HelperText="PhoneNumber" @ref="phoneField"/>
                        <MudDivider/>
                        <MudTextField T="float" Label="Amount" HelperText="Add Money" @ref="moneyField" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Add" OnAdornmentClick="OnBuyMoney" AdornmentAriaLabel="Add Money" />
                    </MudStack>
                }
                
                <MudDivider/>
                @if (payments.Any()) {
                    <MudText Typo="Typo.h6" Class="mb-4">Payments</MudText>
                    <MudStack>
                        @foreach (var payment in payments) {
                            <MudPaper>
                                <MudStack>
                                    <MudText Typo="Typo.body2" Class="mb-4">To</MudText>
                                    <MudText Typo="Typo.h6" Class="mb-4">@payment.toId</MudText>
                                    <MudText Typo="Typo.body2" Class="mb-4">Reason</MudText>
                                    @if (payment.reasonType == PaymentReasonType.Flashcard) {
                                        <MudText Typo="Typo.body1" Class="mb-4">Flashcard Purchase - @payment.reason</MudText>
                                    }else if (payment.reasonType == PaymentReasonType.Quiz) {
                                        <MudText Typo="Typo.body1" Class="mb-4">Quiz Purchase - @payment.reason</MudText>
                                    }else {
                                        <MudText Typo="Typo.body1" Class="mb-4">Transfer - @payment.reason</MudText>
                                    }
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                }
                @if (incomings.Any()) {
                    <MudText Typo="Typo.h6" Class="mb-4">Incomings</MudText>
                    <MudStack>
                        @foreach (var payment in incomings) {
                            <MudPaper>
                                <MudStack>
                                    <MudText Typo="Typo.body2" Class="mb-4">From</MudText>
                                    <MudText Typo="Typo.h6" Class="mb-4">@payment.fromId</MudText>
                                    <MudText Typo="Typo.body2" Class="mb-4">Reason</MudText>
                                    @if (payment.reasonType == PaymentReasonType.Flashcard) {
                                        <MudText Typo="Typo.body1" Class="mb-4">Flashcard Purchase - @payment.reason</MudText>
                                    }else if (payment.reasonType == PaymentReasonType.Quiz) {
                                        <MudText Typo="Typo.body1" Class="mb-4">Quiz Purchase - @payment.reason</MudText>
                                    }else if (payment.reasonType == PaymentReasonType.Transfer) {
                                        <MudText Typo="Typo.body1" Class="mb-4">Transfer - @payment.reason</MudText>
                                    }else {
                                        <MudText Typo="Typo.body1" Class="mb-4">Added Money - @payment.reason</MudText>
                                    }
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                }
            }
        </MudCard>
   </DialogContent>
</MudDialog>

@code {
    [Parameter]
    public Action<User?> OnUserUpdated {get; set;} = (x) => {};
    private HubConnection? hub;
    private User current_user;
    private User? transferUser;
    private bool isBuying = false;
    private List<Payment> payments = [];
    private List<Payment> incomings = [];
    private MudTextField<float> moneyField;
    private MudTextField<string> reasonField;
    private MudTextField<string> phoneField;
    private bool allowDev = false;

    private async Task OnAddMoney()
    {
        if (moneyField is null || current_user is null ) return;
        
        var user = await hub.InvokeAsync<User?>(nameof(IAppHubServer.AddMoneyToUser), current_user.id, moneyField.Value);
        if (user is not null) {
            current_user = user;
            await sessionStorage.SetItemAsync("user", user);
            OnUserUpdated(user);
        }
        await moneyField.Clear();
        StateHasChanged();
    }

    private async Task OnTransferMoney()
    {
        if (moneyField is null || transferUser is null || current_user is null || moneyField.Value > current_user.money) return;
        
        var payment = await hub.InvokeAsync<Payment?>(nameof(IAppHubServer.ProcessPayment), new Payment {
            fromId = current_user.id,
            toId = transferUser.id,
            amount = moneyField.Value,
            reason = reasonField?.Value ?? "",
            reasonType = PaymentReasonType.Transfer,
        });
        if (payment is not null) payments.Add(payment);
        var user = await hub.InvokeAsync<User?>(nameof(IAppHubServer.CheckUser), current_user.id);
        if (user is not null) {
            current_user = user;
            await sessionStorage.SetItemAsync("user", user);
            OnUserUpdated(user);
        }
        await moneyField.Clear();
        transferUser = null;
        StateHasChanged();
    }

    private async Task OnBuyMoney()
    {
        if (moneyField is null || phoneField is null || !phoneField.Value.Any() || transferUser is null || current_user is null || moneyField.Value > current_user.money) return;
        
        var payment = await hub.InvokeAsync<Payment?>(nameof(IAppHubServer.ProcessPayment), new Payment {
            fromId = phoneField.Value,
            toId = current_user.id,
            amount = moneyField.Value,
            reason = reasonField?.Value ?? "",
            reasonType = PaymentReasonType.Buy,
        });

        if (payment is not null) payments.Add(payment);
        await moneyField.Clear();
        isBuying = false;
        StateHasChanged();
    }

    private Task OnTransfer()
    {
        return Dialog.ShowAsync<SearchUserDialog>("", new DialogParameters() {
            ["OnUserSelected"] = (User? user) => {if (current_user.id != user.id) {transferUser = user;}},
        },new DialogOptions()
        {

            CloseOnEscapeKey = true 
        });
    }

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            if (current_user is not null) {
                try {
                    payments = await hub.InvokeAsync<List<Payment>>(nameof(IAppHubServer.GetDisplayPayments), current_user.id);
                    incomings = payments.Where((x) => x.toId == current_user.id).ToList();
                    payments = payments.Where((x) => x.fromId == current_user.id).ToList();
                } catch (Exception e) {}
            }
        }
    }

    private Task OnLogin() {
        return Dialog.ShowAsync<LoginDialog>("",new DialogOptions()
        {

            CloseOnEscapeKey = true 
        });
    }

    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}